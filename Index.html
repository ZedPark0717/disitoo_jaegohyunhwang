<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WMS Raw Data → Dashboard (Single HTML)</title>
  <style>
    :root{
      --bg:#f6f7f9;
      --card:#ffffff;
      --line:#d9dee7;
      --text:#1b1f2a;
      --muted:#6b7280;
      --accent:#2563eb;
      --warn:#f59e0b;
      --danger:#b91c1c;
      --ok:#16a34a;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Noto Sans KR, Arial, "Apple SD Gothic Neo", sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    header{ padding:18px 18px 8px; }
    h1{ margin:0 0 6px; font-size:18px; font-weight:800; }
    .sub{ margin:0; color:var(--muted); font-size:13px; line-height:1.4; }
    .wrap{
      padding: 12px 18px 24px;
      display:grid;
      gap:12px;
      grid-template-columns: 1fr;
    }
    .row2{
      display:grid;
      gap:12px;
      grid-template-columns: 1.1fr 0.9fr;
    }
    @media (max-width: 1000px){ .row2{grid-template-columns: 1fr;} }
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:14px;
      padding:14px;
      box-shadow: 0 1px 0 rgba(16,24,40,.04);
    }
    .card h2{ margin:0 0 10px; font-size:14px; font-weight:800; }
    .grid{
      display:grid;
      gap:10px;
      grid-template-columns: repeat(6, 1fr);
      align-items:end;
    }
    @media (max-width: 900px){ .grid{grid-template-columns: repeat(2, 1fr);} }
    label{ display:block; font-size:12px; color:var(--muted); margin-bottom:6px; }
    input, select{
      width:100%;
      padding:10px 10px;
      border-radius:10px;
      border:1px solid var(--line);
      background:#fff;
      outline:none;
      font-size:13px;
    }
    input:focus, select:focus{border-color:rgba(37,99,235,.7); box-shadow:0 0 0 3px rgba(37,99,235,.12)}
    .btns{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:10px;
      align-items:center;
    }
    button{
      border:1px solid var(--line);
      background:#fff;
      padding:10px 12px;
      border-radius:10px;
      font-weight:700;
      font-size:13px;
      cursor:pointer;
    }
    button.primary{
      background:var(--accent);
      color:#fff;
      border-color:rgba(37,99,235,.5);
    }
    button.danger{
      background:#fff;
      border-color:#f1c7c7;
      color:var(--danger);
    }
    button.warn{
      background: rgba(245,158,11,.10);
      border-color: rgba(245,158,11,.35);
      color: #b45309;
    }
    button:disabled{ opacity:.5; cursor:not-allowed; }
    .hint{ margin-top:8px; font-size:12px; color:var(--muted); line-height:1.5; }
    .toolbar{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
      margin-bottom:10px;
    }
    .toolbar .spacer{flex:1}
    table{
      width:100%;
      border-collapse:collapse;
      font-size:13px;
      overflow:hidden;
      border-radius:12px;
      border:1px solid var(--line);
      background:#fff;
    }
    th, td{
      padding:10px 10px;
      border-bottom:1px solid var(--line);
      text-align:left;
      vertical-align:middle;
    }
    th{
      background:#f3f5f9;
      font-size:12px;
      color:#374151;
      font-weight:900;
    }
    tr:last-child td{border-bottom:none}
    .pill{
      display:inline-block;
      padding:4px 8px;
      border-radius:999px;
      font-size:12px;
      font-weight:800;
      border:1px solid var(--line);
      background:#fff;
    }
    .pill.c{border-color:rgba(37,99,235,.25); background:rgba(37,99,235,.06); color:#1d4ed8}
    .pill.t{border-color:rgba(245,158,11,.35); background:rgba(245,158,11,.08); color:#b45309}
    .pill.ship{
      border-color: rgba(34,197,94,.35);
      background: rgba(34,197,94,.10);
      color: #166534;
    }
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
    .small{font-size:12px;color:var(--muted)}
    .actions button{
      padding:7px 10px;
      border-radius:9px;
      font-size:12px;
      margin-right:6px;
      margin-bottom:4px;
    }
    .file{ display:none; }

    .statusBar{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      padding:10px 12px;
      border:1px dashed var(--line);
      border-radius:12px;
      background:#fff;
      margin:10px 0 0;
    }
    .dot{
      width:10px;height:10px;border-radius:50%;
      background:#9ca3af;
      display:inline-block;
      margin-right:6px;
      vertical-align:middle;
    }
    .dot.ok{ background: var(--ok); }
    .dot.warn{ background: var(--warn); }
    .dot.bad{ background: var(--danger); }

    /* Modal */
    .modalOverlay{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.35);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:999;
    }
    .modal{
      width:min(520px, 100%);
      background:#fff;
      border:1px solid var(--line);
      border-radius:14px;
      padding:14px;
      box-shadow: 0 10px 30px rgba(0,0,0,.18);
    }
    .modal h3{
      margin:0 0 10px;
      font-size:14px;
      font-weight:900;
    }
    .modalGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      align-items:end;
    }
    @media (max-width: 520px){
      .modalGrid{ grid-template-columns: 1fr; }
    }
    .modalFooter{
      display:flex;
      gap:8px;
      justify-content:flex-end;
      margin-top:12px;
    }
  </style>
</head>

<body>
  <header>
    <h1>Raw Data 입력 → Dashboard</h1>
    <p class="sub">
      오더번호 자동생성: <span class="mono">매장번호_월_일_구분(C/T)</span> 예) <span class="mono">9230_12_19_C</span> /
      저장: 로컬 또는 서버 DB(API)
    </p>

    <div class="statusBar">
      <div>
        <span class="small">저장 위치</span><br/>
        <select id="storageMode">
          <option value="local">로컬(브라우저)</option>
          <option value="server">서버 DB(API)</option>
        </select>
      </div>
      <div style="min-width:240px">
        <span class="small">서버 상태</span><br/>
        <span id="serverStatus" class="small"><span class="dot"></span>미연결</span>
      </div>
      <div class="spacer"></div>
      <div>
        <button id="pullBtn">서버에서 불러오기</button>
        <button class="primary" id="pushBtn">서버에 저장</button>
      </div>
      <div class="small" id="syncHint"></div>
    </div>
  </header>

  <main class="wrap">
    <section class="card">
      <h2>1) Raw Data 입력</h2>
      <div class="grid">
        <div>
          <label>매장번호</label>
          <input id="store" type="number" placeholder="예: 9230" />
        </div>
        <div>
          <label>오더 생성일</label>
          <input id="date" type="date" />
        </div>
        <div>
          <label>성별</label>
          <select id="gender">
            <option value="">선택</option>
            <option value="CRO">CRO</option>
            <option value="NINO">NINO</option>
            <option value="SRA">SRA</option>
          </select>
        </div>
        <div>
          <label>구분</label>
          <select id="type">
            <option value="">선택</option>
            <option value="C">의류 (C)</option>
            <option value="T">신발 (T)</option>
          </select>
        </div>
        <div>
          <label>박스 수량</label>
          <input id="boxes" type="number" min="0" step="1" placeholder="예: 2" />
        </div>
        <div>
          <label>미리보기 오더번호</label>
          <input id="orderPreview" class="mono" type="text" readonly placeholder="자동 생성" />
        </div>
      </div>

      <div class="btns">
        <button class="primary" id="addBtn">추가</button>
        <button id="sampleBtn">샘플 데이터 넣기</button>
        <button class="danger" id="clearBtn">전체 삭제</button>
        <span class="spacer"></span>
        <button id="exportBtn">CSV 내보내기</button>
        <button id="importBtn">CSV 가져오기</button>
        <input id="fileInput" class="file" type="file" accept=".csv,text/csv" />
      </div>

      <div class="hint">
        - 오더번호는 생성일 기반으로 자동 생성됩니다. (월/일은 2자리로 고정)<br/>
        - 입력일자는 행을 "추가/수정"한 시간 기준으로 자동 저장됩니다.<br/>
        - CSV 가져오기는 컬럼명이 아래 중 하나면 됩니다:
        <span class="mono">store, date, gender, type, boxes</span> 또는
        <span class="mono">매장번호, 오더생성일, 성별, 구분, 박스</span>
      </div>
    </section>

    <section class="row2">
      <section class="card">
        <h2>2) KPI (매장별 박스 수량: C / T)</h2>

        <div class="toolbar" style="margin-bottom:8px;">
          <span class="small">※ 현재 선택한 필터 기준으로 집계됩니다.</span>
          <span class="spacer"></span>
          <span class="small" id="kpiSummary"></span>
        </div>

        <table>
          <thead>
            <tr>
              <th style="width:140px">매장</th>
              <th style="width:160px">C 박스</th>
              <th style="width:160px">T 박스</th>
              <th style="width:160px">합계</th>
            </tr>
          </thead>
          <tbody id="kpiTbody"></tbody>
        </table>

        <div class="hint">
          - C = 의류 / T = 신발
        </div>
      </section>

      <section class="card">
        <h2>3) 필터</h2>
        <div class="grid" style="grid-template-columns: repeat(3, 1fr);">
          <div>
            <label>매장번호</label>
            <input id="fStore" type="text" placeholder="예: 9230 (비우면 전체)" />
          </div>
          <div>
            <label>성별</label>
            <select id="fGender">
              <option value="">전체</option>
              <option value="CRO">CRO</option>
              <option value="NINO">NINO</option>
              <option value="SRA">SRA</option>
            </select>
          </div>
          <div>
            <label>구분</label>
            <select id="fType">
              <option value="">전체</option>
              <option value="C">의류(C)</option>
              <option value="T">신발(T)</option>
            </select>
          </div>
        </div>
        <div class="btns">
          <button id="resetFilterBtn">필터 초기화</button>
        </div>
        <div class="hint">
          매장번호는 부분 입력도 됩니다. (예: <span class="mono">92</span> 입력 시 <span class="mono">9230</span> 포함)
        </div>
      </section>
    </section>

    <section class="card">
      <h2>4) 출고현황판 (출고일/시간 기준)</h2>

      <div class="toolbar">
        <span class="small">정렬:</span>
        <select id="shipSort">
          <option value="shipDesc">출고일자 ↓</option>
          <option value="shipAsc">출고일자 ↑</option>
          <option value="storeAsc">매장번호 ↑</option>
          <option value="storeDesc">매장번호 ↓</option>
        </select>
        <span class="spacer"></span>
        <span class="small" id="shipSummary"></span>
      </div>

      <table>
        <thead>
          <tr>
            <th style="width:140px">출고일</th>
            <th style="width:120px">출고시간</th>
            <th style="width:120px">매장</th>
            <th style="width:220px">오더번호</th>
            <th style="width:120px">성별</th>
            <th style="width:120px">구분</th>
            <th style="width:120px">박스</th>
            <th style="width:120px">작업</th>
          </tr>
        </thead>
        <tbody id="shipTbody"></tbody>
      </table>

      <div class="hint">
        - <b>출고</b> 버튼을 누르면 출고일/시간을 선택할 수 있습니다.<br/>
        - 출고 처리된 건은 이 표에 자동으로 올라옵니다.
      </div>
    </section>

    <section class="card">
      <h2>5) Dashboard (입력일자 / 매장 / 오더 / 성별 / 구분 / 박스 수량)</h2>

      <div class="toolbar">
        <span class="small">정렬:</span>
        <select id="sort">
          <option value="dateDesc">오더 생성일 ↓</option>
          <option value="dateAsc">오더 생성일 ↑</option>
          <option value="inputDesc">입력일자 ↓</option>
          <option value="inputAsc">입력일자 ↑</option>
          <option value="storeAsc">매장번호 ↑</option>
          <option value="storeDesc">매장번호 ↓</option>
          <option value="boxesDesc">박스 ↓</option>
          <option value="boxesAsc">박스 ↑</option>
        </select>
        <span class="spacer"></span>
        <span class="small" id="lastSaved"></span>
      </div>

      <table>
        <thead>
          <tr>
            <th style="width:200px">입력일자</th>
            <th style="width:120px">매장</th>
            <th style="width:220px">오더번호</th>
            <th style="width:120px">성별</th>
            <th style="width:120px">구분</th>
            <th style="width:120px">박스</th>
            <th style="width:220px">작업</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </section>
  </main>

  <!-- Modal: 출고 처리 -->
  <div class="modalOverlay" id="shipModalOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="shipModalTitle">
      <h3 id="shipModalTitle">출고 처리</h3>

      <div class="small" id="shipModalInfo" style="margin-bottom:10px;"></div>

      <div class="modalGrid">
        <div>
          <label>출고일</label>
          <input id="shipDate" type="date" />
        </div>
        <div>
          <label>출고시간</label>
          <input id="shipTime" type="time" />
        </div>
      </div>

      <div class="modalFooter">
        <button id="shipCancelBtn">취소</button>
        <button class="primary" id="shipSaveBtn">출고 확정</button>
      </div>

      <div class="hint" style="margin-top:10px;">
        - 출고 확정 시 해당 오더는 출고현황판에 표시됩니다.<br/>
        - 출고 취소는 출고현황판에서 가능합니다.
      </div>
    </div>
  </div>

  <script>
    /******************************************************************
     * ✅ 설정: 서버 API 주소만 바꾸면 됩니다.
     * - GitHub Pages에 올릴 거면, 백엔드 서버를 따로 띄우고 그 주소를 넣으세요.
     * - 예) https://your-wms-api.example.com
     ******************************************************************/
    const API_BASE = "https://script.google.com/macros/s/1xOMmwY7jfTrcjPb0QsyYMHgc0G_Y_QUWwRzKUylxobM/exec"; // <-- 여기에 서버 주소 입력. 예: "https://your-api.com"
    const STORAGE_KEY = "wms_raw_rows_v1";
    const MODE_KEY = "wms_storage_mode_v1";

    /**
     * 서버 API 규격 (이 HTML이 기대하는 형태)
     * GET  {API_BASE}/api/rows      -> { rows: [...] }
     * PUT  {API_BASE}/api/rows      -> body: { rows:[...] }  (서버에 전체 저장)
     *
     * ※ 충돌 해결: 클라이언트에서 merge 후 PUT (최신 updatedAt 우선)
     */

    /**
     * Row shape:
     * {
     *  id, store, date, gender, type, boxes, orderNo,
     *  createdAt?: ISOString, updatedAt?: ISOString,
     *  ship?: { shipDate:string(YYYY-MM-DD), shipTime:string(HH:MM), shippedAt:ISOString }
     * }
     */
    let rows = loadLocalRows();

    // ----- 상태 UI -----
    const $storageMode = document.getElementById("storageMode");
    const $serverStatus = document.getElementById("serverStatus");
    const $pullBtn = document.getElementById("pullBtn");
    const $pushBtn = document.getElementById("pushBtn");
    const $syncHint = document.getElementById("syncHint");

    function setStatus(text, level){
      const dot = `<span class="dot ${level||""}"></span>`;
      $serverStatus.innerHTML = dot + escapeHtml(text);
    }

    function isServerMode(){
      return ($storageMode.value === "server");
    }

    function serverConfigured(){
      return !!(API_BASE && API_BASE.trim());
    }

    // ----- Local storage -----
    function loadLocalRows(){
      try{
        const s = localStorage.getItem(STORAGE_KEY);
        if(!s) return [];
        const parsed = JSON.parse(s);
        if(!Array.isArray(parsed)) return [];
        return parsed.map(r => normalizeRow(r)).filter(Boolean);
      }catch(e){
        return [];
      }
    }

    function saveLocalRows(){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(rows));
      const el = document.getElementById("lastSaved");
      const now = new Date();
      el.textContent = "저장됨: " + now.toLocaleString();
    }

    function loadMode(){
      const m = localStorage.getItem(MODE_KEY);
      if(m === "server" || m === "local") return m;
      return "local";
    }
    function saveMode(m){
      localStorage.setItem(MODE_KEY, m);
    }

    // ----- Utils -----
    function pad2(n){
      const x = String(n);
      return x.length === 1 ? "0" + x : x;
    }

    function makeOrderNo(store, dateStr, type){
      if(!store || !dateStr || !type) return "";
      const d = new Date(dateStr + "T00:00:00");
      const mm = pad2(d.getMonth() + 1);
      const dd = pad2(d.getDate());
      return `${store}_${mm}_${dd}_${type}`;
    }

    function typeLabel(type){
      return type === "C" ? "의류" : "신발";
    }

    function escapeHtml(str){
      return String(str)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function uid(){
      return Math.random().toString(16).slice(2) + "-" + Date.now().toString(16);
    }

    function fmtDateTime(iso){
      if(!iso) return "";
      const d = new Date(iso);
      if(Number.isNaN(d.getTime())) return "";
      return d.toLocaleString();
    }

    function getInputAt(row){
      return row.updatedAt || row.createdAt || "";
    }

    function todayISODate(){
      const d = new Date();
      return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
    }

    function nowHHMM(){
      const d = new Date();
      return `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
    }

    function shipKey(ship){
      if(!ship) return "";
      const t = (ship.shipTime || "").trim();
      return `${ship.shipDate || ""} ${t}`;
    }

    function normalizeRow(r){
      if(!r || typeof r !== "object") return null;
      const out = {
        ...r,
        id: String(r.id || ""),
        store: String(r.store || "").trim(),
        date: String(r.date || "").trim(),
        gender: String(r.gender || "").trim(),
        type: String(r.type || "").trim(),
        boxes: Number(r.boxes) || 0,
        orderNo: String(r.orderNo || "").trim(),
        createdAt: r.createdAt ? String(r.createdAt) : "",
        updatedAt: r.updatedAt ? String(r.updatedAt) : "",
        ship: (r.ship && typeof r.ship === "object") ? {
          shipDate: r.ship.shipDate ? String(r.ship.shipDate) : "",
          shipTime: r.ship.shipTime ? String(r.ship.shipTime) : "",
          shippedAt: r.ship.shippedAt ? String(r.ship.shippedAt) : ""
        } : null
      };
      if(!out.id) out.id = uid();
      if(!out.orderNo) out.orderNo = makeOrderNo(out.store, out.date, out.type);
      return out;
    }

    function safeIsoToTime(iso){
      const d = new Date(iso);
      if(Number.isNaN(d.getTime())) return 0;
      return d.getTime();
    }

    // ----- Merge (충돌 해결: 최신 updatedAt/createdAt 우선) -----
    function mergeRows(localArr, remoteArr){
      const map = new Map();
      for(const r of (localArr||[])){
        const nr = normalizeRow(r);
        if(!nr) continue;
        map.set(nr.id, nr);
      }
      for(const r of (remoteArr||[])){
        const nr = normalizeRow(r);
        if(!nr) continue;

        const existed = map.get(nr.id);
        if(!existed){
          map.set(nr.id, nr);
          continue;
        }

        const tA = safeIsoToTime(existed.updatedAt || existed.createdAt);
        const tB = safeIsoToTime(nr.updatedAt || nr.createdAt);

        map.set(nr.id, (tB >= tA) ? nr : existed);
      }
      return Array.from(map.values());
    }

    // ----- Server API -----
    async function apiGetRows(){
      const res = await fetch(API_BASE.replace(/\/$/,"") + "/api/rows", { method:"GET" });
      if(!res.ok) throw new Error("GET 실패: " + res.status);
      const data = await res.json();
      if(!data || !Array.isArray(data.rows)) return [];
      return data.rows.map(normalizeRow).filter(Boolean);
    }

    async function apiPutRows(allRows){
      const res = await fetch(API_BASE.replace(/\/$/,"") + "/api/rows", {
        method:"PUT",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ rows: allRows })
      });
      if(!res.ok) throw new Error("PUT 실패: " + res.status);
      const data = await res.json().catch(()=>null);
      return data;
    }

    let pushTimer = null;
    function scheduleAutoPush(){
      if(!isServerMode()) return;
      if(!serverConfigured()) return;

      clearTimeout(pushTimer);
      pushTimer = setTimeout(async ()=>{
        try{
          setStatus("저장 중…", "warn");
          // remote 먼저 받아서 merge 후 업로드 (덮어쓰기 충돌 최소화)
          const remote = await apiGetRows();
          rows = mergeRows(rows, remote);
          saveLocalRows(); // 로컬에도 캐시
          await apiPutRows(rows);
          setStatus("연결됨 / 저장 완료", "ok");
          $syncHint.textContent = "서버 모드: 변경 시 자동 저장됩니다.";
          render();
        }catch(e){
          setStatus("서버 저장 실패 (API 확인)", "bad");
          $syncHint.textContent = String(e?.message || e);
        }
      }, 700);
    }

    async function pullFromServer(){
      if(!serverConfigured()){
        alert("API_BASE가 비어있습니다. HTML 상단 설정에서 서버 주소를 넣어주세요.");
        return;
      }
      try{
        setStatus("불러오는 중…", "warn");
        const remote = await apiGetRows();
        rows = mergeRows(rows, remote);
        saveLocalRows();
        setStatus("연결됨 / 불러오기 완료", "ok");
        $syncHint.textContent = `서버에서 ${remote.length}건 불러옴 (로컬과 병합됨)`;
        render();
      }catch(e){
        setStatus("불러오기 실패 (API 확인)", "bad");
        $syncHint.textContent = String(e?.message || e);
        alert("서버에서 불러오기에 실패했습니다.\n" + (e?.message || e));
      }
    }

    async function pushToServerNow(){
      if(!serverConfigured()){
        alert("API_BASE가 비어있습니다. HTML 상단 설정에서 서버 주소를 넣어주세요.");
        return;
      }
      try{
        setStatus("저장 중…", "warn");
        const remote = await apiGetRows();
        rows = mergeRows(rows, remote);
        saveLocalRows();
        await apiPutRows(rows);
        setStatus("연결됨 / 저장 완료", "ok");
        $syncHint.textContent = `서버에 ${rows.length}건 저장 완료`;
      }catch(e){
        setStatus("서버 저장 실패 (API 확인)", "bad");
        $syncHint.textContent = String(e?.message || e);
        alert("서버 저장에 실패했습니다.\n" + (e?.message || e));
      }
    }

    // ----- Elements -----
    const $store = document.getElementById("store");
    const $date = document.getElementById("date");
    const $gender = document.getElementById("gender");
    const $type = document.getElementById("type");
    const $boxes = document.getElementById("boxes");
    const $orderPreview = document.getElementById("orderPreview");

    const $addBtn = document.getElementById("addBtn");
    const $sampleBtn = document.getElementById("sampleBtn");
    const $clearBtn = document.getElementById("clearBtn");
    const $exportBtn = document.getElementById("exportBtn");
    const $importBtn = document.getElementById("importBtn");
    const $fileInput = document.getElementById("fileInput");

    const $tbody = document.getElementById("tbody");
    const $sort = document.getElementById("sort");

    const $fStore = document.getElementById("fStore");
    const $fGender = document.getElementById("fGender");
    const $fType = document.getElementById("fType");
    const $resetFilterBtn = document.getElementById("resetFilterBtn");

    const $kpiTbody = document.getElementById("kpiTbody");
    const $kpiSummary = document.getElementById("kpiSummary");

    const $shipTbody = document.getElementById("shipTbody");
    const $shipSummary = document.getElementById("shipSummary");
    const $shipSort = document.getElementById("shipSort");

    // Modal
    const $shipModalOverlay = document.getElementById("shipModalOverlay");
    const $shipModalInfo = document.getElementById("shipModalInfo");
    const $shipDate = document.getElementById("shipDate");
    const $shipTime = document.getElementById("shipTime");
    const $shipCancelBtn = document.getElementById("shipCancelBtn");
    const $shipSaveBtn = document.getElementById("shipSaveBtn");

    let shipTargetRowId = null;

    (function initDefaultDate(){
      $date.value = todayISODate();
    })();

    function updateOrderPreview(){
      const store = ($store.value || "").trim();
      const dateStr = ($date.value || "").trim();
      const type = ($type.value || "").trim();
      $orderPreview.value = makeOrderNo(store, dateStr, type);
    }

    ["input","change"].forEach(evt=>{
      $store.addEventListener(evt, updateOrderPreview);
      $date.addEventListener(evt, updateOrderPreview);
      $type.addEventListener(evt, updateOrderPreview);
    });
    updateOrderPreview();

    function getFilteredRows(){
      const fs = ($fStore.value || "").trim();
      const fg = ($fGender.value || "").trim();
      const ft = ($fType.value || "").trim();

      let out = rows.slice();

      if(fs) out = out.filter(r => String(r.store).includes(fs));
      if(fg) out = out.filter(r => r.gender === fg);
      if(ft) out = out.filter(r => r.type === ft);

      const mode = $sort.value;
      out.sort((a,b)=>{
        if(mode === "dateDesc") return (b.date||"").localeCompare(a.date||"");
        if(mode === "dateAsc") return (a.date||"").localeCompare(b.date||"");
        if(mode === "inputDesc") return String(getInputAt(b)).localeCompare(String(getInputAt(a)));
        if(mode === "inputAsc") return String(getInputAt(a)).localeCompare(String(getInputAt(b)));
        if(mode === "storeAsc") return String(a.store).localeCompare(String(b.store));
        if(mode === "storeDesc") return String(b.store).localeCompare(String(a.store));
        if(mode === "boxesDesc") return (b.boxes||0) - (a.boxes||0);
        if(mode === "boxesAsc") return (a.boxes||0) - (b.boxes||0);
        return 0;
      });

      return out;
    }

    function renderKPI(filtered){
      const map = new Map(); // store -> {c,t}
      for(const r of filtered){
        const store = String(r.store);
        if(!map.has(store)) map.set(store, {c:0, t:0});
        const agg = map.get(store);
        if(r.type === "C") agg.c += (Number(r.boxes)||0);
        if(r.type === "T") agg.t += (Number(r.boxes)||0);
      }

      const stores = Array.from(map.keys()).sort((a,b)=>a.localeCompare(b));
      const totalC = stores.reduce((acc,s)=>acc + map.get(s).c, 0);
      const totalT = stores.reduce((acc,s)=>acc + map.get(s).t, 0);
      const total = totalC + totalT;

      $kpiSummary.textContent = `전체(C/T/합계): ${totalC} / ${totalT} / ${total} (필터 기준)`;

      if(stores.length === 0){
        $kpiTbody.innerHTML = `<tr><td colspan="4" class="small">표시할 데이터가 없습니다.</td></tr>`;
        return;
      }

      $kpiTbody.innerHTML = stores.map(s=>{
        const c = map.get(s).c;
        const t = map.get(s).t;
        const sum = c + t;
        return `
          <tr>
            <td class="mono">${escapeHtml(s)}</td>
            <td class="mono">${escapeHtml(c)}</td>
            <td class="mono">${escapeHtml(t)}</td>
            <td class="mono">${escapeHtml(sum)}</td>
          </tr>
        `;
      }).join("");
    }

    function getShippedRows(){
      return rows.filter(r => r.ship && r.ship.shipDate && r.ship.shipTime);
    }

    function renderShippingBoard(){
      const shipped = getShippedRows().slice();

      const mode = $shipSort.value;
      shipped.sort((a,b)=>{
        const ak = shipKey(a.ship);
        const bk = shipKey(b.ship);
        if(mode === "shipDesc") return bk.localeCompare(ak);
        if(mode === "shipAsc") return ak.localeCompare(bk);
        if(mode === "storeAsc") return String(a.store).localeCompare(String(b.store));
        if(mode === "storeDesc") return String(b.store).localeCompare(String(a.store));
        return 0;
      });

      const totalBoxes = shipped.reduce((acc,r)=>acc + (Number(r.boxes)||0), 0);
      $shipSummary.textContent = `출고 ${shipped.length}건 / 박스 ${totalBoxes}`;

      if(shipped.length === 0){
        $shipTbody.innerHTML = `<tr><td colspan="8" class="small">출고 처리된 데이터가 없습니다.</td></tr>`;
        return;
      }

      $shipTbody.innerHTML = shipped.map(r=>{
        const pillClass = r.type === "C" ? "pill c" : "pill t";
        return `
          <tr>
            <td class="mono">${escapeHtml(r.ship.shipDate)}</td>
            <td class="mono">${escapeHtml(r.ship.shipTime)}</td>
            <td class="mono">${escapeHtml(r.store)}</td>
            <td class="mono">${escapeHtml(r.orderNo)}</td>
            <td>${escapeHtml(r.gender)}</td>
            <td><span class="${pillClass}">${typeLabel(r.type)} (${r.type})</span></td>
            <td class="mono">${escapeHtml(r.boxes)}</td>
            <td class="actions">
              <button class="danger" onclick="unshipRow('${r.id}')">출고 취소</button>
            </td>
          </tr>
        `;
      }).join("");
    }

    function render(){
      const data = getFilteredRows();

      $tbody.innerHTML = data.map(r=>{
        const pillClass = r.type === "C" ? "pill c" : "pill t";
        const inputAt = fmtDateTime(getInputAt(r));
        const shipped = !!(r.ship && r.ship.shipDate && r.ship.shipTime);
        const shipBadge = shipped ? `<span class="pill ship">출고완료</span>` : ``;

        return `
          <tr>
            <td class="mono">${escapeHtml(inputAt || "-")}</td>
            <td class="mono">${escapeHtml(r.store)}</td>
            <td class="mono">${escapeHtml(r.orderNo)} ${shipBadge}</td>
            <td>${escapeHtml(r.gender)}</td>
            <td><span class="${pillClass}">${typeLabel(r.type)} (${r.type})</span></td>
            <td class="mono">${escapeHtml(r.boxes)}</td>
            <td class="actions">
              <button onclick="editRow('${r.id}')">수정</button>
              <button class="warn" onclick="openShipModal('${r.id}')">출고</button>
              <button class="danger" onclick="deleteRow('${r.id}')">삭제</button>
            </td>
          </tr>
        `;
      }).join("");

      renderKPI(data);
      renderShippingBoard();
    }

    // Row actions
    window.deleteRow = function(id){
      const ok = confirm("해당 행을 삭제할까요?");
      if(!ok) return;
      rows = rows.filter(r => r.id !== id);
      saveLocalRows();
      render();
      scheduleAutoPush();
    }

    window.editRow = function(id){
      const r = rows.find(x => x.id === id);
      if(!r) return;

      $store.value = r.store;
      $date.value = r.date;
      $gender.value = r.gender;
      $type.value = r.type;
      $boxes.value = r.boxes;

      updateOrderPreview();

      $addBtn.textContent = "수정 반영";
      $addBtn.classList.add("primary");
      $addBtn.dataset.editing = id;
      window.scrollTo({top:0, behavior:"smooth"});
    }

    function resetAddMode(){
      $addBtn.textContent = "추가";
      delete $addBtn.dataset.editing;
    }

    // Shipping modal
    function showModal(){
      $shipModalOverlay.style.display = "flex";
      $shipModalOverlay.setAttribute("aria-hidden", "false");
    }
    function hideModal(){
      $shipModalOverlay.style.display = "none";
      $shipModalOverlay.setAttribute("aria-hidden", "true");
      shipTargetRowId = null;
    }

    window.openShipModal = function(id){
      const r = rows.find(x => x.id === id);
      if(!r) return;

      shipTargetRowId = id;

      $shipModalInfo.innerHTML = `
        <div><b>오더:</b> <span class="mono">${escapeHtml(r.orderNo)}</span></div>
        <div class="small"><b>매장:</b> <span class="mono">${escapeHtml(r.store)}</span> /
          <b>성별:</b> ${escapeHtml(r.gender)} /
          <b>구분:</b> ${escapeHtml(typeLabel(r.type))}(${escapeHtml(r.type)}) /
          <b>박스:</b> <span class="mono">${escapeHtml(r.boxes)}</span>
        </div>
      `;

      $shipDate.value = (r.ship && r.ship.shipDate) ? r.ship.shipDate : todayISODate();
      $shipTime.value = (r.ship && r.ship.shipTime) ? r.ship.shipTime : nowHHMM();

      showModal();
    }

    window.unshipRow = function(id){
      const r = rows.find(x => x.id === id);
      if(!r) return;

      const ok = confirm("출고를 취소할까요?");
      if(!ok) return;

      r.ship = null;
      r.updatedAt = new Date().toISOString();
      saveLocalRows();
      render();
      scheduleAutoPush();
    }

    $shipCancelBtn.addEventListener("click", hideModal);
    $shipModalOverlay.addEventListener("click", (e)=>{
      if(e.target === $shipModalOverlay) hideModal();
    });

    $shipSaveBtn.addEventListener("click", ()=>{
      if(!shipTargetRowId) return;

      const shipDate = ($shipDate.value || "").trim();
      const shipTime = ($shipTime.value || "").trim();

      if(!shipDate){ alert("출고일을 선택해주세요."); return; }
      if(!shipTime){ alert("출고시간을 선택해주세요."); return; }

      const r = rows.find(x => x.id === shipTargetRowId);
      if(!r) return;

      r.ship = { shipDate, shipTime, shippedAt: new Date().toISOString() };
      r.updatedAt = new Date().toISOString();

      saveLocalRows();
      render();
      hideModal();
      scheduleAutoPush();
    });

    document.addEventListener("keydown", (e)=>{
      if(e.key === "Escape" && $shipModalOverlay.style.display === "flex"){
        hideModal();
      }
    });

    // Add / update row
    $addBtn.addEventListener("click", ()=>{
      const store = ($store.value || "").trim();
      const dateStr = ($date.value || "").trim();
      const gender = ($gender.value || "").trim();
      const type = ($type.value || "").trim();
      const boxes = Number(($boxes.value || "").trim());

      if(!store){ alert("매장번호를 입력해주세요."); return; }
      if(!dateStr){ alert("오더 생성일을 선택해주세요."); return; }
      if(!gender){ alert("성별을 선택해주세요."); return; }
      if(!(type === "C" || type === "T")){ alert("구분을 선택해주세요. (C/T)"); return; }
      if(!Number.isFinite(boxes) || boxes < 0){ alert("박스 수량을 0 이상 숫자로 입력해주세요."); return; }

      const orderNo = makeOrderNo(store, dateStr, type);
      if(!orderNo){ alert("오더번호 생성에 실패했습니다. 입력값을 확인해주세요."); return; }

      const nowIso = new Date().toISOString();
      const editingId = $addBtn.dataset.editing;

      if(editingId){
        const idx = rows.findIndex(r => r.id === editingId);
        if(idx >= 0){
          rows[idx] = {
            ...rows[idx],
            store,
            date: dateStr,
            gender,
            type,
            boxes,
            orderNo,
            updatedAt: nowIso,
            createdAt: rows[idx].createdAt || nowIso,
            ship: rows[idx].ship || null
          };
        }
        resetAddMode();
      }else{
        rows.push({
          id: uid(),
          store,
          date: dateStr,
          gender,
          type,
          boxes,
          orderNo,
          createdAt: nowIso,
          updatedAt: "",
          ship: null
        });
      }

      saveLocalRows();
      render();
      scheduleAutoPush();

      $boxes.value = "";
      updateOrderPreview();
    });

    $sampleBtn.addEventListener("click", ()=>{
      const now = new Date().toISOString();
      const sample = [
        {store:"9230", date:"2025-12-07", gender:"CRO", type:"T", boxes:2},
        {store:"9230", date:"2025-12-10", gender:"CRO", type:"T", boxes:2},
        {store:"9230", date:"2025-12-13", gender:"NINO", type:"T", boxes:2},
        {store:"9230", date:"2025-12-15", gender:"NINO", type:"T", boxes:3},
        {store:"9230", date:"2025-12-18", gender:"SRA", type:"T", boxes:5},
      ].map(x => ({
        id: uid(),
        ...x,
        orderNo: makeOrderNo(x.store, x.date, x.type),
        createdAt: now,
        updatedAt: "",
        ship: null
      }));

      rows = rows.concat(sample);
      saveLocalRows();
      render();
      scheduleAutoPush();
    });

    $clearBtn.addEventListener("click", ()=>{
      const ok = confirm("전체 데이터를 삭제할까요? (되돌릴 수 없음)");
      if(!ok) return;
      rows = [];
      saveLocalRows();
      render();
      resetAddMode();
      scheduleAutoPush();
    });

    // Filters & sort
    [$fStore, $fGender, $fType, $sort].forEach(el=>{
      el.addEventListener("input", render);
      el.addEventListener("change", render);
    });
    $shipSort.addEventListener("change", render);

    $resetFilterBtn.addEventListener("click", ()=>{
      $fStore.value = "";
      $fGender.value = "";
      $fType.value = "";
      render();
    });

    // CSV Export/Import
    $exportBtn.addEventListener("click", ()=>{
      const header = [
        "store","date","gender","type","boxes","orderNo","createdAt","updatedAt",
        "shipDate","shipTime","shippedAt"
      ];
      const lines = [header.join(",")].concat(
        rows.map(r => [
          r.store, r.date, r.gender, r.type, r.boxes, r.orderNo, r.createdAt||"", r.updatedAt||"",
          (r.ship?.shipDate||""), (r.ship?.shipTime||""), (r.ship?.shippedAt||"")
        ].map(v => `"${String(v).replaceAll('"','""')}"`).join(","))
      );
      const blob = new Blob([lines.join("\n")], {type:"text/csv;charset=utf-8"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "wms_raw_data.csv";
      document.body.appendChild(a);
      a.click();
      a.remove();
    });

    $importBtn.addEventListener("click", ()=>{
      $fileInput.value = "";
      $fileInput.click();
    });

    $fileInput.addEventListener("change", async (e)=>{
      const file = e.target.files?.[0];
      if(!file) return;

      const text = await file.text();
      const parsed = parseCSV(text);
      if(parsed.length === 0){
        alert("CSV에서 데이터를 찾지 못했습니다.");
        return;
      }

      const cols = parsed[0].map(c => String(c).trim());
      const idx = (names) => cols.findIndex(c => names.includes(c));

      const iStore = idx(["store","매장번호","매장 번호"]);
      const iDate  = idx(["date","오더생성일","오더 생성일","생성일"]);
      const iGender= idx(["gender","성별"]);
      const iType  = idx(["type","구분"]);
      const iBoxes = idx(["boxes","박스","박스수량","박스 수량"]);
      const iOrderNo = idx(["orderNo","오더번호","오더 번호"]);

      const iCreatedAt = idx(["createdAt","입력일자","created_at","created"]);
      const iUpdatedAt = idx(["updatedAt","수정일자","updated_at","updated"]);

      const iShipDate = idx(["shipDate","출고일","출고일자"]);
      const iShipTime = idx(["shipTime","출고시간"]);
      const iShippedAt = idx(["shippedAt","출고처리일시","출고처리"]);

      if([iStore,iDate,iGender,iType,iBoxes].some(x=>x<0)){
        alert("필수 컬럼을 찾을 수 없습니다. (store/date/gender/type/boxes)");
        return;
      }

      const incoming = [];
      for(let i=1;i<parsed.length;i++){
        const row = parsed[i];
        if(row.length === 0) continue;

        const store = String(row[iStore] ?? "").trim();
        const dateStr = normalizeDate(String(row[iDate] ?? "").trim());
        const gender = String(row[iGender] ?? "").trim();
        const typeRaw = String(row[iType] ?? "").trim().toUpperCase();
        const type = (typeRaw === "의류" ? "C" : typeRaw === "신발" ? "T" : typeRaw);
        const boxes = Number(String(row[iBoxes] ?? "").trim());

        const createdAt = iCreatedAt >= 0 ? String(row[iCreatedAt] ?? "").trim() : "";
        const updatedAt = iUpdatedAt >= 0 ? String(row[iUpdatedAt] ?? "").trim() : "";

        let ship = null;
        if(iShipDate >= 0 && iShipTime >= 0){
          const sd = String(row[iShipDate] ?? "").trim();
          const st = String(row[iShipTime] ?? "").trim();
          const sa = iShippedAt >= 0 ? String(row[iShippedAt] ?? "").trim() : "";
          if(sd && st){
            ship = {
              shipDate: normalizeDate(sd) || sd,
              shipTime: st,
              shippedAt: (sa && !Number.isNaN(new Date(sa).getTime())) ? sa : ""
            };
          }
        }

        if(!store || !dateStr || !gender || !(type==="C"||type==="T") || !Number.isFinite(boxes)) continue;

        const nowIso = new Date().toISOString();
        const orderNoFromFile = (iOrderNo >= 0) ? String(row[iOrderNo] ?? "").trim() : "";
        const orderNo = orderNoFromFile || makeOrderNo(store, dateStr, type);

        incoming.push({
          id: uid(),
          store,
          date: dateStr,
          gender,
          type,
          boxes,
          orderNo,
          createdAt: (createdAt && !Number.isNaN(new Date(createdAt).getTime())) ? createdAt : nowIso,
          updatedAt: (updatedAt && !Number.isNaN(new Date(updatedAt).getTime())) ? updatedAt : "",
          ship
        });
      }

      if(incoming.length === 0){
        alert("가져올 유효 데이터가 없습니다. (형식/값 확인 필요)");
        return;
      }

      rows = rows.concat(incoming);
      saveLocalRows();
      render();
      scheduleAutoPush();
      alert(`가져오기 완료: ${incoming.length}건`);
    });

    function parseCSV(text){
      const out = [];
      let row = [];
      let cur = "";
      let inQuotes = false;

      for(let i=0;i<text.length;i++){
        const ch = text[i];
        const next = text[i+1];

        if(inQuotes){
          if(ch === '"' && next === '"'){ cur += '"'; i++; continue; }
          if(ch === '"'){ inQuotes = false; continue; }
          cur += ch; continue;
        }else{
          if(ch === '"'){ inQuotes = true; continue; }
          if(ch === ','){ row.push(cur); cur=""; continue; }
          if(ch === '\n'){
            row.push(cur); cur="";
            row = row.map(x => typeof x === "string" ? x.replace(/\r$/, "") : x);
            if(row.some(c => String(c).trim() !== "")) out.push(row);
            row = [];
            continue;
          }
          cur += ch;
        }
      }
      row.push(cur);
      row = row.map(x => typeof x === "string" ? x.replace(/\r$/, "") : x);
      if(row.some(c => String(c).trim() !== "")) out.push(row);
      return out;
    }

    function normalizeDate(s){
      if(!s) return "";
      if(/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
      if(/^\d{4}\/\d{1,2}\/\d{1,2}$/.test(s)){
        const [y,m,d] = s.split("/");
        return `${y}-${pad2(Number(m))}-${pad2(Number(d))}`;
      }
      if(/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(s)){
        const [m,d,y] = s.split("/");
        return `${y}-${pad2(Number(m))}-${pad2(Number(d))}`;
      }
      return "";
    }

    // ----- Mode + Sync UI init -----
    (function initMode(){
      const m = loadMode();
      $storageMode.value = m;

      if(m === "server"){
        if(!serverConfigured()){
          setStatus("서버 모드(미설정) - API_BASE 입력 필요", "bad");
          $syncHint.textContent = "API_BASE를 설정하면 공용 DB로 동작합니다.";
        }else{
          setStatus("서버 모드 - 연결 확인 필요", "warn");
          $syncHint.textContent = "서버에서 불러오기를 먼저 권장합니다.";
        }
      }else{
        setStatus("로컬 모드", "");
        $syncHint.textContent = "로컬 모드: 이 PC/브라우저에만 저장됩니다.";
      }
    })();

    $storageMode.addEventListener("change", async ()=>{
      saveMode($storageMode.value);

      if(isServerMode()){
        if(!serverConfigured()){
          setStatus("서버 모드(미설정) - API_BASE 입력 필요", "bad");
          $syncHint.textContent = "API_BASE를 설정하면 공용 DB로 동작합니다.";
          return;
        }
        setStatus("서버 모드 - 불러오기 권장", "warn");
        $syncHint.textContent = "서버에서 불러오기 후 작업하세요.";
      }else{
        setStatus("로컬 모드", "");
        $syncHint.textContent = "로컬 모드: 이 PC/브라우저에만 저장됩니다.";
      }
    });

    $pullBtn.addEventListener("click", pullFromServer);
    $pushBtn.addEventListener("click", pushToServerNow);

    // Initial render
    saveLocalRows();
    render();
  </script>
</body>
</html>

