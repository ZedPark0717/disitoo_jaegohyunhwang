<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WMS Raw Data â†’ Dashboard (Single HTML)</title>
  <style>
    :root{
      --bg:#f6f7f9;
      --card:#ffffff;
      --line:#d9dee7;
      --text:#1b1f2a;
      --muted:#6b7280;
      --accent:#2563eb;
      --warn:#f59e0b;
      --danger:#b91c1c;
      --ok:#16a34a;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Noto Sans KR, Arial, "Apple SD Gothic Neo", sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    header{ padding:18px 18px 8px; }
    h1{ margin:0 0 6px; font-size:18px; font-weight:800; }
    .sub{ margin:0; color:var(--muted); font-size:13px; line-height:1.4; }
    .wrap{
      padding: 12px 18px 24px;
      display:grid;
      gap:12px;
      grid-template-columns: 1fr;
    }
    .row2{
      display:grid;
      gap:12px;
      grid-template-columns: 1.1fr 0.9fr;
    }
    @media (max-width: 1000px){ .row2{grid-template-columns: 1fr;} }
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:14px;
      padding:14px;
      box-shadow: 0 1px 0 rgba(16,24,40,.04);
    }
    .card h2{ margin:0 0 10px; font-size:14px; font-weight:800; }
    .grid{
      display:grid;
      gap:10px;
      grid-template-columns: repeat(6, 1fr);
      align-items:end;
    }
    @media (max-width: 900px){ .grid{grid-template-columns: repeat(2, 1fr);} }
    label{ display:block; font-size:12px; color:var(--muted); margin-bottom:6px; }
    input, select{
      width:100%;
      padding:10px 10px;
      border-radius:10px;
      border:1px solid var(--line);
      background:#fff;
      outline:none;
      font-size:13px;
    }
    input:focus, select:focus{border-color:rgba(37,99,235,.7); box-shadow:0 0 0 3px rgba(37,99,235,.12)}
    .btns{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:10px;
      align-items:center;
    }
    button{
      border:1px solid var(--line);
      background:#fff;
      padding:10px 12px;
      border-radius:10px;
      font-weight:700;
      font-size:13px;
      cursor:pointer;
    }
    button.primary{
      background:var(--accent);
      color:#fff;
      border-color:rgba(37,99,235,.5);
    }
    button.danger{
      background:#fff;
      border-color:#f1c7c7;
      color:var(--danger);
    }
    button.warn{
      background: rgba(245,158,11,.10);
      border-color: rgba(245,158,11,.35);
      color: #b45309;
    }
    button:disabled{ opacity:.5; cursor:not-allowed; }
    .hint{ margin-top:8px; font-size:12px; color:var(--muted); line-height:1.5; }
    .toolbar{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
      margin-bottom:10px;
    }
    .toolbar .spacer{flex:1}
    table{
      width:100%;
      border-collapse:collapse;
      font-size:13px;
      overflow:hidden;
      border-radius:12px;
      border:1px solid var(--line);
      background:#fff;
    }
    th, td{
      padding:10px 10px;
      border-bottom:1px solid var(--line);
      text-align:left;
      vertical-align:middle;
    }
    th{
      background:#f3f5f9;
      font-size:12px;
      color:#374151;
      font-weight:900;
    }
    tr:last-child td{border-bottom:none}
    .pill{
      display:inline-block;
      padding:4px 8px;
      border-radius:999px;
      font-size:12px;
      font-weight:800;
      border:1px solid var(--line);
      background:#fff;
    }
    .pill.c{border-color:rgba(37,99,235,.25); background:rgba(37,99,235,.06); color:#1d4ed8}
    .pill.t{border-color:rgba(245,158,11,.35); background:rgba(245,158,11,.08); color:#b45309}
    .pill.ship{
      border-color: rgba(34,197,94,.35);
      background: rgba(34,197,94,.10);
      color: #166534;
    }
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
    .small{font-size:12px;color:var(--muted)}
    .actions button{
      padding:7px 10px;
      border-radius:9px;
      font-size:12px;
      margin-right:6px;
      margin-bottom:4px;
    }
    .file{ display:none; }

    .statusBar{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      padding:10px 12px;
      border:1px dashed var(--line);
      border-radius:12px;
      background:#fff;
      margin:10px 0 0;
    }
    .dot{
      width:10px;height:10px;border-radius:50%;
      background:#9ca3af;
      display:inline-block;
      margin-right:6px;
      vertical-align:middle;
    }
    .dot.ok{ background: var(--ok); }
    .dot.warn{ background: var(--warn); }
    .dot.bad{ background: var(--danger); }

    /* Modal */
    .modalOverlay{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.35);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:999;
    }
    .modal{
      width:min(520px, 100%);
      background:#fff;
      border:1px solid var(--line);
      border-radius:14px;
      padding:14px;
      box-shadow: 0 10px 30px rgba(0,0,0,.18);
    }
    .modal h3{
      margin:0 0 10px;
      font-size:14px;
      font-weight:900;
    }
    .modalGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      align-items:end;
    }
    @media (max-width: 520px){
      .modalGrid{ grid-template-columns: 1fr; }
    }
    .modalFooter{
      display:flex;
      gap:8px;
      justify-content:flex-end;
      margin-top:12px;
    }
  </style>
</head>

<body>
  <header>
    <h1>Raw Data ì…ë ¥ â†’ Dashboard</h1>
    <p class="sub">
      ì˜¤ë”ë²ˆí˜¸ ìë™ìƒì„±: <span class="mono">ë§¤ì¥ë²ˆí˜¸_ì›”_ì¼_êµ¬ë¶„(C/T)</span> ì˜ˆ) <span class="mono">9230_12_19_C</span> /
      ì €ì¥: ë¡œì»¬ ë˜ëŠ” ì„œë²„ DB(API)
    </p>

    <div class="statusBar">
      <div>
        <span class="small">ì €ì¥ ìœ„ì¹˜</span><br/>
        <select id="storageMode">
          <option value="local">ë¡œì»¬(ë¸Œë¼ìš°ì €)</option>
          <option value="server">ì„œë²„ DB(API)</option>
        </select>
      </div>
      <div style="min-width:240px">
        <span class="small">ì„œë²„ ìƒíƒœ</span><br/>
        <span id="serverStatus" class="small"><span class="dot"></span>ë¯¸ì—°ê²°</span>
      </div>
      <div class="spacer"></div>
      <div>
        <button id="pullBtn">ì„œë²„ì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°</button>
        <button class="primary" id="pushBtn">ì„œë²„ì— ì €ì¥</button>
      </div>
      <div class="small" id="syncHint"></div>
    </div>
  </header>

  <main class="wrap">
    <section class="card">
      <h2>1) Raw Data ì…ë ¥</h2>
      <div class="grid">
        <div>
          <label>ë§¤ì¥ë²ˆí˜¸</label>
          <input id="store" type="number" placeholder="ì˜ˆ: 9230" />
        </div>
        <div>
          <label>ì˜¤ë” ìƒì„±ì¼</label>
          <input id="date" type="date" />
        </div>
        <div>
          <label>ì„±ë³„</label>
          <select id="gender">
            <option value="">ì„ íƒ</option>
            <option value="CRO">CRO</option>
            <option value="NINO">NINO</option>
            <option value="SRA">SRA</option>
          </select>
        </div>
        <div>
          <label>êµ¬ë¶„</label>
          <select id="type">
            <option value="">ì„ íƒ</option>
            <option value="C">ì˜ë¥˜ (C)</option>
            <option value="T">ì‹ ë°œ (T)</option>
          </select>
        </div>
        <div>
          <label>ë°•ìŠ¤ ìˆ˜ëŸ‰</label>
          <input id="boxes" type="number" min="0" step="1" placeholder="ì˜ˆ: 2" />
        </div>
        <div>
          <label>ë¯¸ë¦¬ë³´ê¸° ì˜¤ë”ë²ˆí˜¸</label>
          <input id="orderPreview" class="mono" type="text" readonly placeholder="ìë™ ìƒì„±" />
        </div>
      </div>

      <div class="btns">
        <button class="primary" id="addBtn">ì¶”ê°€</button>
        <button id="sampleBtn">ìƒ˜í”Œ ë°ì´í„° ë„£ê¸°</button>
        <button class="danger" id="clearBtn">ì „ì²´ ì‚­ì œ</button>
        <span class="spacer"></span>
        <button id="exportBtn">CSV ë‚´ë³´ë‚´ê¸°</button>
        <button id="importBtn">CSV ê°€ì ¸ì˜¤ê¸°</button>
        <input id="fileInput" class="file" type="file" accept=".csv,text/csv" />
      </div>

      <div class="hint">
        - ì˜¤ë”ë²ˆí˜¸ëŠ” ìƒì„±ì¼ ê¸°ë°˜ìœ¼ë¡œ ìë™ ìƒì„±ë©ë‹ˆë‹¤. (ì›”/ì¼ì€ 2ìë¦¬ë¡œ ê³ ì •)<br/>
        - ì…ë ¥ì¼ìëŠ” í–‰ì„ "ì¶”ê°€/ìˆ˜ì •"í•œ ì‹œê°„ ê¸°ì¤€ìœ¼ë¡œ ìë™ ì €ì¥ë©ë‹ˆë‹¤.<br/>
        - CSV ê°€ì ¸ì˜¤ê¸°ëŠ” ì»¬ëŸ¼ëª…ì´ ì•„ë˜ ì¤‘ í•˜ë‚˜ë©´ ë©ë‹ˆë‹¤:
        <span class="mono">store, date, gender, type, boxes</span> ë˜ëŠ”
        <span class="mono">ë§¤ì¥ë²ˆí˜¸, ì˜¤ë”ìƒì„±ì¼, ì„±ë³„, êµ¬ë¶„, ë°•ìŠ¤</span>
      </div>
    </section>

    <section class="row2">
      <section class="card">
        <h2>2) KPI (ë§¤ì¥ë³„ ë°•ìŠ¤ ìˆ˜ëŸ‰: C / T)</h2>

        <div class="toolbar" style="margin-bottom:8px;">
          <span class="small">â€» í˜„ì¬ ì„ íƒí•œ í•„í„° ê¸°ì¤€ìœ¼ë¡œ ì§‘ê³„ë©ë‹ˆë‹¤.</span>
          <span class="spacer"></span>
          <span class="small" id="kpiSummary"></span>
        </div>

        <table>
          <thead>
            <tr>
              <th style="width:140px">ë§¤ì¥</th>
              <th style="width:160px">C ë°•ìŠ¤</th>
              <th style="width:160px">T ë°•ìŠ¤</th>
              <th style="width:160px">í•©ê³„</th>
            </tr>
          </thead>
          <tbody id="kpiTbody"></tbody>
        </table>

        <div class="hint">
          - C = ì˜ë¥˜ / T = ì‹ ë°œ
        </div>
      </section>

      <section class="card">
        <h2>3) í•„í„°</h2>
        <div class="grid" style="grid-template-columns: repeat(3, 1fr);">
          <div>
            <label>ë§¤ì¥ë²ˆí˜¸</label>
            <input id="fStore" type="text" placeholder="ì˜ˆ: 9230 (ë¹„ìš°ë©´ ì „ì²´)" />
          </div>
          <div>
            <label>ì„±ë³„</label>
            <select id="fGender">
              <option value="">ì „ì²´</option>
              <option value="CRO">CRO</option>
              <option value="NINO">NINO</option>
              <option value="SRA">SRA</option>
            </select>
          </div>
          <div>
            <label>êµ¬ë¶„</label>
            <select id="fType">
              <option value="">ì „ì²´</option>
              <option value="C">ì˜ë¥˜(C)</option>
              <option value="T">ì‹ ë°œ(T)</option>
            </select>
          </div>
        </div>
        <div class="btns">
          <button id="resetFilterBtn">í•„í„° ì´ˆê¸°í™”</button>
        </div>
        <div class="hint">
          ë§¤ì¥ë²ˆí˜¸ëŠ” ë¶€ë¶„ ì…ë ¥ë„ ë©ë‹ˆë‹¤. (ì˜ˆ: <span class="mono">92</span> ì…ë ¥ ì‹œ <span class="mono">9230</span> í¬í•¨)
        </div>
      </section>
    </section>

    <section class="card">
      <h2>4) ì¶œê³ í˜„í™©íŒ (ì¶œê³ ì¼/ì‹œê°„ ê¸°ì¤€)</h2>

      <div class="toolbar">
        <span class="small">ì •ë ¬:</span>
        <select id="shipSort">
          <option value="shipDesc">ì¶œê³ ì¼ì â†“</option>
          <option value="shipAsc">ì¶œê³ ì¼ì â†‘</option>
          <option value="storeAsc">ë§¤ì¥ë²ˆí˜¸ â†‘</option>
          <option value="storeDesc">ë§¤ì¥ë²ˆí˜¸ â†“</option>
        </select>
        <span class="spacer"></span>
        <span class="small" id="shipSummary"></span>
      </div>

      <table>
        <thead>
          <tr>
            <th style="width:140px">ì¶œê³ ì¼</th>
            <th style="width:120px">ì¶œê³ ì‹œê°„</th>
            <th style="width:120px">ë§¤ì¥</th>
            <th style="width:220px">ì˜¤ë”ë²ˆí˜¸</th>
            <th style="width:120px">ì„±ë³„</th>
            <th style="width:120px">êµ¬ë¶„</th>
            <th style="width:120px">ë°•ìŠ¤</th>
            <th style="width:120px">ì‘ì—…</th>
          </tr>
        </thead>
        <tbody id="shipTbody"></tbody>
      </table>

      <div class="hint">
        - <b>ì¶œê³ </b> ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ì¶œê³ ì¼/ì‹œê°„ì„ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br/>
        - ì¶œê³  ì²˜ë¦¬ëœ ê±´ì€ ì´ í‘œì— ìë™ìœ¼ë¡œ ì˜¬ë¼ì˜µë‹ˆë‹¤.
      </div>
    </section>

    <section class="card">
      <h2>5) Dashboard (ì…ë ¥ì¼ì / ë§¤ì¥ / ì˜¤ë” / ì„±ë³„ / êµ¬ë¶„ / ë°•ìŠ¤ ìˆ˜ëŸ‰)</h2>

      <div class="toolbar">
        <span class="small">ì •ë ¬:</span>
        <select id="sort">
          <option value="dateDesc">ì˜¤ë” ìƒì„±ì¼ â†“</option>
          <option value="dateAsc">ì˜¤ë” ìƒì„±ì¼ â†‘</option>
          <option value="inputDesc">ì…ë ¥ì¼ì â†“</option>
          <option value="inputAsc">ì…ë ¥ì¼ì â†‘</option>
          <option value="storeAsc">ë§¤ì¥ë²ˆí˜¸ â†‘</option>
          <option value="storeDesc">ë§¤ì¥ë²ˆí˜¸ â†“</option>
          <option value="boxesDesc">ë°•ìŠ¤ â†“</option>
          <option value="boxesAsc">ë°•ìŠ¤ â†‘</option>
        </select>
        <span class="spacer"></span>
        <span class="small" id="lastSaved"></span>
      </div>

      <table>
        <thead>
          <tr>
            <th style="width:200px">ì…ë ¥ì¼ì</th>
            <th style="width:120px">ë§¤ì¥</th>
            <th style="width:220px">ì˜¤ë”ë²ˆí˜¸</th>
            <th style="width:120px">ì„±ë³„</th>
            <th style="width:120px">êµ¬ë¶„</th>
            <th style="width:120px">ë°•ìŠ¤</th>
            <th style="width:220px">ì‘ì—…</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </section>
  </main>

  <!-- Modal: ì¶œê³  ì²˜ë¦¬ -->
  <div class="modalOverlay" id="shipModalOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="shipModalTitle">
      <h3 id="shipModalTitle">ì¶œê³  ì²˜ë¦¬</h3>

      <div class="small" id="shipModalInfo" style="margin-bottom:10px;"></div>

      <div class="modalGrid">
        <div>
          <label>ì¶œê³ ì¼</label>
          <input id="shipDate" type="date" />
        </div>
        <div>
          <label>ì¶œê³ ì‹œê°„</label>
          <input id="shipTime" type="time" />
        </div>
      </div>

      <div class="modalFooter">
        <button id="shipCancelBtn">ì·¨ì†Œ</button>
        <button class="primary" id="shipSaveBtn">ì¶œê³  í™•ì •</button>
      </div>

      <div class="hint" style="margin-top:10px;">
        - ì¶œê³  í™•ì • ì‹œ í•´ë‹¹ ì˜¤ë”ëŠ” ì¶œê³ í˜„í™©íŒì— í‘œì‹œë©ë‹ˆë‹¤.<br/>
        - ì¶œê³  ì·¨ì†ŒëŠ” ì¶œê³ í˜„í™©íŒì—ì„œ ê°€ëŠ¥í•©ë‹ˆë‹¤.
      </div>
    </div>
  </div>

<script>
/******************************************************************
 * âœ… Google Apps Script ì „ìš© ì„¤ì • (PUT/DELETE ì•ˆ ì”€)
 ******************************************************************/
const API_BASE = "https://script.google.com/macros/s/AKfycbyoADxgqXCWVhWSdGz4N0fk3WaXHAJZuPRae4D0CbFvCYuGh4BRu_pfpzdEHX1K-pYOzA/exec";
const STORAGE_KEY = "wms_raw_rows_v1";
const MODE_KEY = "wms_storage_mode_v1";

/******************************************************************
 * ê¸°ë³¸ ìœ í‹¸
 ******************************************************************/
function uid(){
  return Math.random().toString(16).slice(2) + "-" + Date.now().toString(16);
}
function pad2(n){ return n < 10 ? "0"+n : ""+n; }
function todayISODate(){
  const d = new Date();
  return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
}
function normalizeRow(r){
  if(!r) return null;
  return {
    id: String(r.id || uid()),
    store: String(r.store||""),
    date: String(r.date||""),
    gender: String(r.gender||""),
    type: String(r.type||""),
    boxes: Number(r.boxes)||0,
    orderNo: String(r.orderNo||""),
    createdAt: r.createdAt||"",
    updatedAt: r.updatedAt||"",
    ship: r.ship || null
  };
}

/******************************************************************
 * ë¡œì»¬ ì €ì¥
 ******************************************************************/
function loadLocalRows(){
  try{
    const s = localStorage.getItem(STORAGE_KEY);
    if(!s) return [];
    return JSON.parse(s).map(normalizeRow);
  }catch(e){ return []; }
}
function saveLocalRows(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(rows));
}

/******************************************************************
 * ğŸ”¥ ì„œë²„ API (Apps Script ì „ìš©)
 ******************************************************************/
async function apiGetRows(){
  const res = await fetch(API_BASE + "?action=list");
  if(!res.ok) throw new Error("GET ì‹¤íŒ¨ " + res.status);
  const data = await res.json();
  return (data.rows||[]).map(normalizeRow);
}

async function apiPutRows(allRows){
  const res = await fetch(API_BASE, {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({
      action: "replaceAll",
      rows: allRows
    })
  });
  if(!res.ok) throw new Error("POST ì‹¤íŒ¨ " + res.status);
  return await res.json();
}

/******************************************************************
 * ìƒíƒœ/ë™ê¸°í™”
 ******************************************************************/
let rows = loadLocalRows();
let pushTimer = null;

function scheduleAutoPush(){
  clearTimeout(pushTimer);
  pushTimer = setTimeout(async ()=>{
    try{
      const remote = await apiGetRows();
      rows = mergeRows(rows, remote);
      saveLocalRows();
      await apiPutRows(rows);
      console.log("âœ… ì„œë²„ ì €ì¥ ì™„ë£Œ");
    }catch(e){
      console.error("âŒ ì„œë²„ ì €ì¥ ì‹¤íŒ¨", e);
    }
  }, 500);
}

function mergeRows(localArr, remoteArr){
  const map = new Map();
  localArr.forEach(r => map.set(r.id, r));
  remoteArr.forEach(r => {
    const old = map.get(r.id);
    if(!old) map.set(r.id, r);
    else{
      const t1 = new Date(old.updatedAt||old.createdAt||0).getTime();
      const t2 = new Date(r.updatedAt||r.createdAt||0).getTime();
      map.set(r.id, t2 >= t1 ? r : old);
    }
  });
  return Array.from(map.values());
}

/******************************************************************
 * ì˜ˆì‹œ ë²„íŠ¼ ë°”ì¸ë”© (ë„ˆ HTMLì— ì´ë¯¸ ìˆìŒ)
 ******************************************************************/
document.getElementById("pullBtn").onclick = async ()=>{
  rows = mergeRows(rows, await apiGetRows());
  saveLocalRows();
  alert("ì„œë²„ì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ");
};

document.getElementById("pushBtn").onclick = async ()=>{
  await apiPutRows(rows);
  alert("ì„œë²„ì— ì €ì¥ ì™„ë£Œ");
};

/******************************************************************
 * ìµœì´ˆ ë Œë”ìš©
 ******************************************************************/
saveLocalRows();
</script>

</body>
</html>



